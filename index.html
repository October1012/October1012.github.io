<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初中英语口语测试</title>
    <!-- 必备工具库 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 微软雅黑, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #ccc;
            border-radius: 8px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            font-size: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 15px;
        }
        button:hover {
            background-color: #45a049;
        }
        .hidden {
            display: none;
        }
        #text-content {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            line-height: 1.8;
        }
        .admin-area {
            text-align: center;
            padding: 50px 0;
        }
        .tip-text {
            color: #666;
            margin: 10px 0;
            font-size: 16px;
        }
        .success-tip {
            color: #27ae60;
            font-size: 18px;
            margin: 15px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 信息填写区（学生/管理员通用） -->
    <div id="info-form">
        <h1>初中英语口语测试</h1>
        <div class="form-group">
            <label for="student-id">学号</label>
            <input type="text" id="student-id" placeholder="请输入学号（如2025001）" required>
        </div>
        <div class="form-group">
            <label for="class">班级</label>
            <input type="text" id="class" placeholder="请输入班级（如初一1班）" required>
        </div>
        <div class="form-group">
            <label for="name">姓名</label>
            <input type="text" id="name" placeholder="请输入姓名" required>
        </div>
        <div class="form-group">
            <label for="gender">性别</label>
            <select id="gender" required>
                <option value="">请选择性别</option>
                <option value="男">男</option>
                <option value="女">女</option>
            </select>
        </div>
        <button onclick="checkIdentity()">进入系统</button>
        <p class="tip-text">提示：学生输入个人信息，管理员输入专属信息</p>
    </div>

    <!-- 学生测试区 -->
    <div id="student-test-area" class="hidden">
        <h2>请朗读下面的英语课文</h2>
        <div id="text-content">
            <!-- 替换成你的课文（纯英文，一行即可） -->
            My School Life My school is a beautiful place. I go to school from Monday to Friday. We have many subjects, like English, math and music. My favorite subject is English. Our English teacher is kind and helpful. After class, I often play games with my classmates. I love my school life very much.
        </div>
        <button onclick="startRecording()">开始录音</button>
        <button onclick="stopRecording()" disabled>停止录音</button>
        <p id="recording-status" style="color: #666; font-size: 18px; margin: 15px 0;"></p>
        <button onclick="submitRecording()" class="hidden">提交录音</button>
    </div>

    <!-- 管理员区 -->
    <div id="admin-area" class="hidden admin-area">
        <h1>管理员模式 - 数据导出</h1>
        <p style="font-size: 18px; margin: 30px 0;">当前已存储 <span id="data-count">0</span> 名学生的测试数据</p>
        <button onclick="exportToExcel()" style="background-color: #2196F3;">导出所有学生成绩（Excel）</button>
        <button onclick="exportAllRecordings()" style="background-color: #ff9800;">导出所有学生录音文件（ZIP包）</button>
        <button onclick="logoutAdmin()" style="background-color: #f44336; margin-top: 20px;">退出管理员模式</button>
    </div>

    <script>
        // ********** 必须改：替换成你的腾讯云密钥 **********
        const TENCENT_SECRET_ID = "AKIDyoTxGOjCZmncFgw6A6qOsAGBGKEwVwDJ";
        const TENCENT_SECRET_KEY = "0pZBcuPsEPKF2f8lHrHWcYMyPemqmW4P";
        // 管理员身份（可自定义）
        const ADMIN_CONFIG = {
            学号: "admin001",
            班级: "管理员",
            姓名: "管理员",
            性别: "男"
        };

        // 全局变量：存储所有学生数据（含成绩+录音，管理员可导出）
        let allStudentData = [];
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;

        // 1. 身份验证：区分学生/管理员
        function checkIdentity() {
            const inputId = document.getElementById("student-id").value.trim();
            const inputClass = document.getElementById("class").value.trim();
            const inputName = document.getElementById("name").value.trim();
            const inputGender = document.getElementById("gender").value.trim();

            if (!inputId || !inputClass || !inputName || !inputGender) {
                alert("请填写完整信息再进入！");
                return;
            }

            // 管理员验证：进入管理模式
            if (
                inputId === ADMIN_CONFIG.学号 &&
                inputClass === ADMIN_CONFIG.班级 &&
                inputName === ADMIN_CONFIG.姓名 &&
                inputGender === ADMIN_CONFIG.性别
            ) {
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("admin-area").classList.remove("hidden");
                // 同步显示已存储的学生数量
                document.getElementById("data-count").textContent = allStudentData.length;
            } else {
                // 学生验证：进入测试模式
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("student-test-area").classList.remove("hidden");
                // 重置录音状态
                document.getElementById("recording-status").textContent = "";
                document.querySelector("button[onclick='startRecording()']").disabled = false;
                document.querySelector("button[onclick='stopRecording()']").disabled = true;
                document.querySelector("button[onclick='submitRecording()']").classList.add("hidden");
                audioChunks = [];
                audioBlob = null;
            }
        }

        // 2. 学生：开始录音
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let supportedMimeType = MediaRecorder.isTypeSupported('audio/webm; codecs=opus') 
                    ? 'audio/webm; codecs=opus' 
                    : MediaRecorder.prototype.mimeType;

                mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => e.data.size > 0 && audioChunks.push(e.data);
                mediaRecorder.onstart = () => {
                    document.getElementById("recording-status").textContent = "正在录音...请朗读课文（读完点击停止）";
                };
                mediaRecorder.onstop = async () => {
                    if (audioChunks.length === 0) {
                        alert("录音失败，请重试！");
                        audioBlob = null;
                        return;
                    }
                    // 转换录音为WAV格式（兼容腾讯云）
                    const tempBlob = new Blob(audioChunks, { type: supportedMimeType });
                    audioBlob = await convertToWav(tempBlob);
                };

                mediaRecorder.start();
                // 禁用开始按钮，启用停止按钮
                document.querySelector("button[onclick='startRecording()']").disabled = true;
                document.querySelector("button[onclick='stopRecording()']").disabled = false;
            } catch (err) {
                alert("录音启动失败！请允许浏览器使用麦克风");
            }
        }

        // 3. 学生：停止录音
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById("recording-status").textContent = "录音已停止，点击提交完成测试";
            // 启用提交按钮
            document.querySelector("button[onclick='submitRecording()']").classList.remove("hidden");
            document.querySelector("button[onclick='startRecording()']").disabled = false;
            document.querySelector("button[onclick='stopRecording()']").disabled = true;
        }

        // 4. 工具函数：录音转WAV格式
        async function convertToWav(inputBlob) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const arrayBuffer = await inputBlob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const offlineContext = new OfflineAudioContext(1, audioBuffer.length * (16000 / audioBuffer.sampleRate), 16000);
            const source = offlineContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(offlineContext.destination);
            source.start(0);

            const resampledBuffer = await offlineContext.startRendering();
            const wavBuffer = new ArrayBuffer(44 + resampledBuffer.length * 2);
            const view = new DataView(wavBuffer);

            // 写入WAV文件头
            view.setUint32(0, 0x46464952, false);
            view.setUint32(4, 36 + resampledBuffer.length * 2, true);
            view.setUint32(8, 0x45564157, false);
            view.setUint32(12, 0x20746d66, false);
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 16000, true);
            view.setUint32(28, 32000, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            view.setUint32(36, 0x61746164, false);
            view.setUint32(40, resampledBuffer.length * 2, true);

            // 写入音频数据
            const channelData = resampledBuffer.getChannelData(0);
            for (let i = 0; i < channelData.length; i++) {
                const sample = Math.max(-1, Math.min(1, channelData[i]));
                view.setInt16(44 + i * 2, sample * 32767, true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // 5. 学生：提交录音（核心逻辑：打分+保存数据+跳回信息页）
        async function submitRecording() {
            if (!audioBlob) {
                alert("请先录音再提交！");
                return;
            }

            try {
                // 1. 转换录音为Base64格式
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                await new Promise(resolve => reader.onload = resolve);
                const audioBase64 = reader.result.split(',')[1];

                // 2. 获取课文文本
                const text = document.getElementById("text-content").textContent.trim();

                // 3. 调用腾讯云口语评测接口
                const url = `https://aai.tencentcloudapi.com/?Action=SentenceRecognition
&ProjectId=0
&SubServiceType=2
&EngSerViceType=EN
&SourceType=1
&Url=
&VoiceFormat=wav
&UsrAudioKey=test_${Date.now()}
&Text=${encodeURIComponent(text)}
&SecretId=${TENCENT_SECRET_ID}
&SecretKey=${TENCENT_SECRET_KEY}
&Version=2018-05-22
&Timestamp=${Math.floor(Date.now()/1000)}
&Nonce=${Math.floor(Math.random()*1000000)}`;

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Data: audioBase64 })
                });
                const result = await response.json();

                // 4. 打分成功：保存数据+提示+跳回信息页
                if (result.Response && result.Response.Result) {
                    const scoreData = result.Response.Result;
                    // 保存学生数据（含成绩+录音）
                    allStudentData.push({
                        学号: document.getElementById("student-id").value.trim(),
                        班级: document.getElementById("class").value.trim(),
                        姓名: document.getElementById("name").value.trim(),
                        性别: document.getElementById("gender").value.trim(),
                        复杂度分数: Math.round(scoreData.Completeness * 100),
                        准确度分数: Math.round(scoreData.Accuracy * 100),
                        流利度分数: Math.round(scoreData.Fluency * 100),
                        测试时间: new Date().toLocaleString(),
                        录音Blob: audioBlob
                    });

                    // 提示测试完毕，跳回信息输入界面
                    alert("测试完毕！请等待老师通知成绩");
                    restartTest();
                } else {
                    // 打分失败：提示错误
                    const errorMsg = result.Response?.Error?.Message || "测试失败，请重试";
                    alert(errorMsg);
                }
            } catch (err) {
                alert("网络异常，测试失败，请检查网络后重试");
            }
        }

        // 6. 学生：跳回信息输入界面（清空输入）
        function restartTest() {
            document.getElementById("student-test-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            // 清空之前的输入内容
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // 7. 管理员：导出Excel成绩表
        function exportToExcel() {
            if (allStudentData.length === 0) {
                alert("暂无学生测试数据，无法导出！");
                return;
            }

            // 整理Excel数据
            const excelData = allStudentData.map(item => ({
                学号: item.学号,
                班级: item.班级,
                姓名: item.姓名,
                性别: item.性别,
                复杂度分数: item.复杂度分数,
                准确度分数: item.准确度分数,
                流利度分数: item.流利度分数,
                测试时间: item.测试时间
            }));

            // 生成并下载Excel
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "学生口语成绩");
            const today = new Date().toLocaleDateString().replace(/\//g, "-");
            XLSX.writeFile(workbook, `初中英语口语测试成绩_${today}.xlsx`);
        }

        // 8. 管理员：导出所有学生录音（ZIP包）
        async function exportAllRecordings() {
            if (allStudentData.length === 0) {
                alert("暂无学生测试数据，无法导出！");
                return;
            }

            const zip = new JSZip();
            // 逐个添加录音文件（命名：学号+姓名.wav）
            allStudentData.forEach(student => {
                const fileName = `${student.学号}_${student.姓名}.wav`;
                zip.file(fileName, student.录音Blob);
            });

            // 生成并下载ZIP包
            const zipContent = await zip.generateAsync({ type: "blob" });
            const today = new Date().toLocaleDateString().replace(/\//g, "-");
            saveAs(zipContent, `学生口语测试录音_${today}.zip`);
        }

        // 9. 管理员：退出管理模式
        function logoutAdmin() {
            document.getElementById("admin-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            // 清空管理员输入
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }
    </script>
</body>
</html>
