<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- æ·»åŠ  Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: å¾®è½¯é›…é»‘, Arial; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, select { width: 100%; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; }
        button { background: #4CAF50; color: white; padding: 15px 30px; font-size: 20px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 10px 0 0; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .hidden { display: none; }
        #text-content { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; line-height: 1.8; border-left: 5px solid #4CAF50; }
        .admin-area { text-align: center; padding: 30px 0; }
        .tip-text { color: #666; margin: 10px 0; font-size: 16px; }
        .recording { animation: pulse 1s infinite; background: #ff4444 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .score-display { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¿¡æ¯å¡«å†™åŒº -->
        <div id="info-form">
            <h1 style="text-align: center; color: #2c3e50;">åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•</h1>
            <div class="form-group">
                <label for="student-id">å­¦å·</label>
                <input type="text" id="student-id" placeholder="è¯·è¾“å…¥å­¦å·ï¼ˆå¦‚2025001ï¼‰" required>
            </div>
            <div class="form-group">
                <label for="class">ç­çº§</label>
                <input type="text" id="class" placeholder="è¯·è¾“å…¥ç­çº§ï¼ˆå¦‚åˆä¸€1ç­ï¼‰" required>
            </div>
            <div class="form-group">
                <label for="name">å§“å</label>
                <input type="text" id="name" placeholder="è¯·è¾“å…¥å§“å" required>
            </div>
            <div class="form-group">
                <label for="gender">æ€§åˆ«</label>
                <select id="gender" required>
                    <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
            </div>
            <button onclick="checkIdentity()" style="width: 100%; background: #3498db;">è¿›å…¥ç³»ç»Ÿ</button>
            <p class="tip-text">æç¤ºï¼šè¯·è¾“å…¥æ‚¨çš„ä¸ªäººä¿¡æ¯å¼€å§‹æµ‹è¯•</p>
        </div>

        <!-- å­¦ç”Ÿæµ‹è¯•åŒº -->
        <div id="student-test-area" class="hidden">
            <h2 style="color: #2c3e50;">è¯·æœ—è¯»ä¸‹é¢çš„è‹±è¯­è¯¾æ–‡</h2>
            <div id="text-content">
                <strong>My School Life</strong><br>
                My school is a beautiful place. I go to school from Monday to Friday. We have many subjects, like English, math and music. My favorite subject is English. Our English teacher is kind and helpful. After class, I often play games with my classmates. I love my school life very much.
            </div>
            <div style="text-align: center;">
                <button id="start-btn" onclick="startRecording()">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                <button id="stop-btn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>
            </div>
            <p id="recording-status" style="text-align: center; font-size: 18px; margin: 20px 0; padding: 10px; border-radius: 5px;"></p>
            <button id="submit-btn" onclick="submitRecording()" class="hidden" disabled style="width: 100%; background: #e74c3c;">æäº¤å½•éŸ³</button>
        </div>

        <!-- ç®¡ç†å‘˜åŒº -->
        <div id="admin-area" class="hidden admin-area">
            <h1 style="color: #2c3e50;">ç®¡ç†å‘˜æ¨¡å¼ - æ•°æ®å¯¼å‡º</h1>
            <div class="score-display">
                <p style="font-size: 20px; margin: 0;">å½“å‰å·²å­˜å‚¨ <span id="data-count" style="color: #e74c3c; font-weight: bold;">0</span> åå­¦ç”Ÿçš„æµ‹è¯•æ•°æ®</p>
            </div>
            <button onclick="refreshData()" style="background: #4CAF50;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button onclick="exportToExcel()" style="background: #2196F3;">ğŸ“Š å¯¼å‡ºæˆç»©ï¼ˆExcelï¼‰</button>
            <button onclick="exportAllRecordings()" style="background: #ff9800;">ğŸµ å¯¼å‡ºå½•éŸ³ï¼ˆZIPåŒ…ï¼‰</button>
            <button onclick="clearAllData()" style="background: #ff5722;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <button onclick="logoutAdmin()" style="background: #f44336; margin-top: 20px;">é€€å‡ºç®¡ç†å‘˜</button>
        </div>

        <!-- ç½‘ç»œçŠ¶æ€æ˜¾ç¤º -->
        <div id="network-status" style="text-align: center; margin-top: 20px; font-size: 14px; color: #666;"></div>
    </div>

    <script>
        // Supabase äº‘æ•°æ®åº“é…ç½®
        const SUPABASE_URL = 'https://lokppsuoecimireoypah.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_CcpqatN_uSSRqd4d1fde0w_vs2QkLcV';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ç®¡ç†å‘˜èº«ä»½
        const ADMIN_CONFIG = {
            å­¦å·: "admin001",
            ç­çº§: "ç®¡ç†å‘˜",
            å§“å: "ç®¡ç†å‘˜",
            æ€§åˆ«: "ç”·"
        };

        // å…¨å±€å˜é‡
        let allStudentData = [];
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;

        // äº‘æ•°æ®åº“å‡½æ•°
        async function saveToCloud(studentData) {
            try {
                // è½¬æ¢å½•éŸ³ä¸ºBase64
                const audioBase64 = await blobToBase64(studentData.å½•éŸ³Blob);
                
                const { data, error } = await supabase
                    .from('student_records')
                    .insert([
                        {
                            å­¦å·: studentData.å­¦å·,
                            ç­çº§: studentData.ç­çº§,
                            å§“å: studentData.å§“å,
                            æ€§åˆ«: studentData.æ€§åˆ«,
                            å‡†ç¡®åº¦åˆ†æ•°: studentData.å‡†ç¡®åº¦åˆ†æ•°,
                            æµåˆ©åº¦åˆ†æ•°: studentData.æµåˆ©åº¦åˆ†æ•°,
                            å®Œæ•´åº¦åˆ†æ•°: studentData.å®Œæ•´åº¦åˆ†æ•°,
                            æµ‹è¯•æ—¶é—´: studentData.æµ‹è¯•æ—¶é—´,
                            å½•éŸ³æ•°æ®: audioBase64
                        }
                    ]);
                
                if (error) throw error;
                updateNetworkStatus('âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
                return true;
            } catch (error) {
                console.error('äº‘å­˜å‚¨å¤±è´¥:', error);
                updateNetworkStatus('âŒ äº‘å­˜å‚¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                allStudentData.push(studentData);
                localStorage.setItem('allStudentData', JSON.stringify(allStudentData));
                return false;
            }
        }

        async function loadFromCloud() {
            try {
                const { data, error } = await supabase
                    .from('student_records')
                    .select('*')
                    .order('æµ‹è¯•æ—¶é—´', { ascending: false });
                
                if (error) throw error;
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                allStudentData = data.map(item => {
                    const audioBlob = base64ToBlob(item.å½•éŸ³æ•°æ®, 'audio/wav');
                    return {
                        å­¦å·: item.å­¦å·,
                        ç­çº§: item.ç­çº§,
                        å§“å: item.å§“å,
                        æ€§åˆ«: item.æ€§åˆ«,
                        å‡†ç¡®åº¦åˆ†æ•°: item.å‡†ç¡®åº¦åˆ†æ•°,
                        æµåˆ©åº¦åˆ†æ•°: item.æµåˆ©åº¦åˆ†æ•°,
                        å®Œæ•´åº¦åˆ†æ•°: item.å®Œæ•´åº¦åˆ†æ•°,
                        æµ‹è¯•æ—¶é—´: item.æµ‹è¯•æ—¶é—´,
                        å½•éŸ³Blob: audioBlob
                    };
                });
                
                updateNetworkStatus('âœ… å·²ä»äº‘ç«¯åŠ è½½æ•°æ®');
                return true;
            } catch (error) {
                console.error('äº‘åŠ è½½å¤±è´¥:', error);
                updateNetworkStatus('âŒ äº‘åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                const localData = localStorage.getItem('allStudentData');
                allStudentData = localData ? JSON.parse(localData) : [];
                return false;
            }
        }

        async function clearCloudData() {
            try {
                const { error } = await supabase
                    .from('student_records')
                    .delete()
                    .neq('å­¦å·', 'æ°¸è¿œä¸ä¼šåˆ é™¤çš„æ¡ä»¶'); // å®‰å…¨åˆ é™¤
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('æ¸…ç©ºäº‘æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }

        // å·¥å…·å‡½æ•°
        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += 1024) {
                const slice = byteCharacters.slice(offset, offset + 1024);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: mimeType });
        }

        function updateNetworkStatus(message) {
            document.getElementById('network-status').textContent = message;
            setTimeout(() => {
                document.getElementById('network-status').textContent = '';
            }, 3000);
        }

        function updateDataCount() {
            const count = allStudentData.length;
            document.getElementById("data-count").textContent = count;
        }

        async function refreshData() {
            setLoading(true, 'åˆ·æ–°æ•°æ®ä¸­...');
            await loadFromCloud();
            updateDataCount();
            setLoading(false);
            alert(`æ•°æ®å·²åˆ·æ–°ï¼Œå½“å‰å…±æœ‰ ${allStudentData.length} æ¡è®°å½•`);
        }

        function setLoading(isLoading, message = '') {
            if (isLoading) {
                document.body.classList.add('loading');
                if (message) {
                    updateNetworkStatus(message);
                }
            } else {
                document.body.classList.remove('loading');
            }
        }

        // 1. èº«ä»½éªŒè¯
        function checkIdentity() {
            const inputId = document.getElementById("student-id").value.trim();
            const inputClass = document.getElementById("class").value.trim();
            const inputName = document.getElementById("name").value.trim();
            const inputGender = document.getElementById("gender").value.trim();

            if (!inputId || !inputClass || !inputName || !inputGender) {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼"); return;
            }

            // ç®¡ç†å‘˜éªŒè¯
            if (inputId === ADMIN_CONFIG.å­¦å· && inputClass === ADMIN_CONFIG.ç­çº§ && 
                inputName === ADMIN_CONFIG.å§“å && inputGender === ADMIN_CONFIG.æ€§åˆ«) {
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("admin-area").classList.remove("hidden");
                refreshData(); // åŠ è½½æœ€æ–°æ•°æ®
            } else {
                // å­¦ç”ŸéªŒè¯
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("student-test-area").classList.remove("hidden");
                resetRecordingState();
            }
        }

        // [å…¶ä½™å‡½æ•°ä¿æŒä¸å˜ï¼šresetRecordingState, startRecording, stopRecording]
        function resetRecordingState() {
            document.getElementById("recording-status").textContent = "";
            document.getElementById("start-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
            document.getElementById("submit-btn").classList.add("hidden");
            document.getElementById("submit-btn").disabled = true;
            document.getElementById("start-btn").classList.remove("recording");
            audioChunks = []; audioBlob = null;
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => e.data.size > 0 && audioChunks.push(e.data);
                mediaRecorder.onstart = () => {
                    document.getElementById("recording-status").textContent = "ğŸ¤ æ­£åœ¨å½•éŸ³...è¯·æ¸…æ™°æœ—è¯»è¯¾æ–‡";
                    document.getElementById("recording-status").style.background = "#ffeaa7";
                    document.getElementById("start-btn").classList.add("recording");
                };
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    document.getElementById("recording-status").textContent = "âœ… å½•éŸ³å®Œæˆï¼ç‚¹å‡»æäº¤";
                    document.getElementById("recording-status").style.background = "#55efc4";
                };
                mediaRecorder.start();
                document.getElementById("start-btn").disabled = true;
                document.getElementById("stop-btn").disabled = false;
            } catch (err) {
                alert("è¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£ï¼");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById("submit-btn").classList.remove("hidden");
            document.getElementById("submit-btn").disabled = false;
            document.getElementById("start-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        // 4. æäº¤å½•éŸ³ï¼ˆä¿å­˜åˆ°äº‘ç«¯ï¼‰
        async function submitRecording() {
            if (!audioBlob) { alert("è¯·å…ˆå½•éŸ³ï¼"); return; }
            
            try {
                setLoading(true, 'ä¿å­˜åˆ°äº‘ç«¯...');
                document.getElementById("submit-btn").disabled = true;
                document.getElementById("submit-btn").textContent = "è¯„æµ‹ä¸­...";
                
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†æ•°
                const duration = audioBlob.size / 1000;
                const baseScore = Math.min(85, 60 + duration / 10);
                const randomVariation = (Math.random() - 0.5) * 20;
                const finalScore = Math.max(50, Math.min(100, baseScore + randomVariation));
                
                const studentData = {
                    å­¦å·: document.getElementById("student-id").value.trim(),
                    ç­çº§: document.getElementById("class").value.trim(),
                    å§“å: document.getElementById("name").value.trim(),
                    æ€§åˆ«: document.getElementById("gender").value.trim(),
                    å‡†ç¡®åº¦åˆ†æ•°: Math.round(finalScore * 0.9),
                    æµåˆ©åº¦åˆ†æ•°: Math.round(finalScore * 0.85),
                    å®Œæ•´åº¦åˆ†æ•°: Math.round(finalScore * 0.95),
                    æµ‹è¯•æ—¶é—´: new Date().toLocaleString(),
                    å½•éŸ³Blob: audioBlob
                };
                
                // ä¿å­˜åˆ°äº‘ç«¯
                await saveToCloud(studentData);
                updateDataCount();

                alert("æµ‹è¯•å·²å®Œæˆï¼æˆç»©å°†ç”±è€å¸ˆç»Ÿä¸€å…¬å¸ƒã€‚");
                restartTest();
            } catch (err) {
                alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•: " + err.message);
            } finally {
                setLoading(false);
                document.getElementById("submit-btn").disabled = false;
                document.getElementById("submit-btn").textContent = "æäº¤å½•éŸ³";
            }
        }

        function restartTest() {
            document.getElementById("student-test-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // 5. å¯¼å‡ºExcel
        function exportToExcel() {
            if (allStudentData.length === 0) { alert("æš‚æ— æ•°æ®ï¼"); return; }
            const excelData = allStudentData.map(item => {
                const { å½•éŸ³Blob, ...data } = item; return data;
            });
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "å­¦ç”Ÿæˆç»©");
            XLSX.writeFile(workbook, `å£è¯­æµ‹è¯•æˆç»©_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 6. å¯¼å‡ºå½•éŸ³
        async function exportAllRecordings() {
            if (allStudentData.length === 0) { alert("æš‚æ— æ•°æ®ï¼"); return; }
            try {
                const zip = new JSZip();
                allStudentData.forEach(student => {
                    if (student.å½•éŸ³Blob) {
                        zip.file(`${student.å­¦å·}_${student.å§“å}.wav`, student.å½•éŸ³Blob);
                    }
                });
                const zipContent = await zip.generateAsync({ type: "blob" });
                saveAs(zipContent, `å­¦ç”Ÿå½•éŸ³_${new Date().toLocaleDateString()}.zip`);
                alert(`æˆåŠŸå¯¼å‡º ${allStudentData.length} ä¸ªå½•éŸ³æ–‡ä»¶ï¼`);
            } catch (err) {
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }

        async function clearAllData() {
            if (confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å­¦ç”Ÿçš„æµ‹è¯•è®°å½•ï¼")) {
                setLoading(true, 'æ¸…ç©ºæ•°æ®ä¸­...');
                const cloudSuccess = await clearCloudData();
                allStudentData = [];
                localStorage.removeItem('allStudentData');
                updateDataCount();
                setLoading(false);
                
                if (cloudSuccess) {
                    alert("äº‘ç«¯å’Œæœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼");
                } else {
                    alert("æœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼Œä½†äº‘ç«¯æ¸…ç©ºå¤±è´¥ï¼");
                }
            }
        }

        function logoutAdmin() {
            document.getElementById("admin-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // åˆå§‹åŒ– - é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async function() {
            await loadFromCloud();
            updateDataCount();
        });
    </script>
</body>
</html>
