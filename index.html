<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初中英语口语测试</title>
    <!-- 必备工具库 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 微软雅黑, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #ccc;
            border-radius: 8px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            font-size: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 15px;
        }
        button:hover {
            background-color: #45a049;
        }
        .hidden {
            display: none;
        }
        #text-content {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            line-height: 1.8;
        }
        .score-item {
            font-size: 20px;
            margin: 15px 0;
            color: #333;
        }
        .admin-area {
            text-align: center;
            padding: 50px 0;
        }
        .tip-text {
            color: #666;
            margin: 10px 0;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="info-form">
        <h1>初中英语口语测试</h1>
        <div class="form-group">
            <label for="student-id">学号</label>
            <input type="text" id="student-id" placeholder="请输入学号（如2025001）" required>
        </div>
        <div class="form-group">
            <label for="class">班级</label>
            <input type="text" id="class" placeholder="请输入班级（如初一1班）" required>
        </div>
        <div class="form-group">
            <label for="name">姓名</label>
            <input type="text" id="name" placeholder="请输入姓名" required>
        </div>
        <div class="form-group">
            <label for="gender">性别</label>
            <select id="gender" required>
                <option value="">请选择性别</option>
                <option value="男">男</option>
                <option value="女">女</option>
            </select>
        </div>
        <button onclick="checkIdentity()">进入系统</button>
        <p class="tip-text">提示：学生输入个人信息，管理员输入专属信息</p>
    </div>

    <div id="student-test-area" class="hidden">
        <h2>请朗读下面的英语课文</h2>
        <div id="text-content">
            My School Life My school is a beautiful place. I go to school from Monday to Friday. We have many subjects, like English, math and music. My favorite subject is English. Our English teacher is kind and helpful. After class, I often play games with my classmates. I love my school life very much.
        </div>
        <button onclick="startRecording()">开始录音</button>
        <button onclick="stopRecording()" disabled>停止录音</button>
        <p id="recording-status" style="color: #666; font-size: 18px; margin: 15px 0;"></p>
        <button onclick="submitRecording()" class="hidden">提交录音，获取打分</button>
    </div>

    <div id="score-area" class="hidden">
        <h2>口语打分结果</h2>
        <div class="score-item">复杂度：<span id="complexity-score">--</span> 分（满分100）</div>
        <div class="score-item">准确度：<span id="accuracy-score">--</span> 分（满分100）</div>
        <div class="score-item">流利度：<span id="fluency-score">--</span> 分（满分100）</div>
        <button onclick="restartTest()">返回重新测试</button>
    </div>

    <div id="admin-area" class="hidden admin-area">
        <h1>管理员模式 - 数据导出</h1>
        <p style="font-size: 18px; margin: 30px 0;">当前已存储 <span id="data-count">0</span> 名学生的测试数据</p>
        <button onclick="exportToExcel()" style="background-color: #2196F3;">导出所有学生成绩（Excel）</button>
        <button onclick="exportAllRecordings()" style="background-color: #ff9800;">导出所有学生录音文件（ZIP包）</button>
        <button onclick="logoutAdmin()" style="background-color: #f44336; margin-top: 20px;">退出管理员模式</button>
    </div>

    <script>
        // ********** 必须改：替换成你的腾讯云密钥 **********
        const TENCENT_SECRET_ID = "AKIDyoTxGOjCZmncFgw6A6qOsAGBGKEwVwDJ";
        const TENCENT_SECRET_KEY = "0pZBcuPsEPKF2f8lHrHWcYMyPemqmW4P";
        // 管理员身份（可自定义）
        const ADMIN_CONFIG = {
            学号: "admin001",
            班级: "管理员",
            姓名: "管理员",
            性别: "男"
        };

        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        let allStudentData = [];

        function checkIdentity() {
            const inputId = document.getElementById("student-id").value.trim();
            const inputClass = document.getElementById("class").value.trim();
            const inputName = document.getElementById("name").value.trim();
            const inputGender = document.getElementById("gender").value.trim();

            if (!inputId || !inputClass || !inputName || !inputGender) {
                alert("请填写完整信息再进入！");
                return;
            }

            if (
                inputId === ADMIN_CONFIG.学号 &&
                inputClass === ADMIN_CONFIG.班级 &&
                inputName === ADMIN_CONFIG.姓名 &&
                inputGender === ADMIN_CONFIG.性别
            ) {
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("admin-area").classList.remove("hidden");
                document.getElementById("data-count").textContent = allStudentData.length;
            } else {
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("student-test-area").classList.remove("hidden");
                document.getElementById("recording-status").textContent = "";
                document.querySelector("button[onclick='startRecording()']").disabled = false;
                document.querySelector("button[onclick='stopRecording()']").disabled = true;
                document.querySelector("button[onclick='submitRecording()']").classList.add("hidden");
                audioChunks = [];
                audioBlob = null;
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                let supportedMimeType = '';
                if (MediaRecorder.isTypeSupported('audio/webm; codecs=opus')) {
                    supportedMimeType = 'audio/webm; codecs=opus';
                } else {
                    supportedMimeType = MediaRecorder.prototype.mimeType;
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMimeType });
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };

                mediaRecorder.onstart = () => {
                    document.getElementById("recording-status").textContent = "正在录音...请朗读课文";
                };

                mediaRecorder.onstop = async () => {
                    if (audioChunks.length === 0) {
                        alert("录音失败，请重试！");
                        audioBlob = null;
                        return;
                    }
                    const tempBlob = new Blob(audioChunks, { type: supportedMimeType });
                    audioBlob = await convertToWav(tempBlob);
                };

                mediaRecorder.start();
                document.querySelector("button[onclick='startRecording()']").disabled = true;
                document.querySelector("button[onclick='stopRecording()']").disabled = false;

            } catch (err) {
                alert("录音启动失败！请允许浏览器使用麦克风");
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById("recording-status").textContent = "录音已停止，点击提交获取打分";
            document.querySelector("button[onclick='startRecording()']").disabled = false;
            document.querySelector("button[onclick='stopRecording()']").disabled = true;
            document.querySelector("button[onclick='submitRecording()']").classList.remove("hidden");
        }

        async function convertToWav(inputBlob) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const arrayBuffer = await inputBlob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const offlineContext = new OfflineAudioContext(1, audioBuffer.length * (16000 / audioBuffer.sampleRate), 16000);
            const source = offlineContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(offlineContext.destination);
            source.start(0);

            const resampledBuffer = await offlineContext.startRendering();
            const wavBuffer = new ArrayBuffer(44 + resampledBuffer.length * 2);
            const view = new DataView(wavBuffer);

            view.setUint32(0, 0x46464952, false);
            view.setUint32(4, 36 + resampledBuffer.length * 2, true);
            view.setUint32(8, 0x45564157, false);
            view.setUint32(12, 0x20746d66, false);
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 16000, true);
            view.setUint32(28, 32000, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            view.setUint32(36, 0x61746164, false);
            view.setUint32(40, resampledBuffer.length * 2, true);

            const channelData = resampledBuffer.getChannelData(0);
            for (let i = 0; i < channelData.length; i++) {
                const sample = Math.max(-1, Math.min(1, channelData[i]));
                view.setInt16(44 + i * 2, sample * 32767, true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // 腾讯云口语评测（无需复杂签名）
        async function submitRecording() {
            if (!audioBlob) {
                alert("请先录音再提交！");
                return;
            }

            try {
                // 转换录音为Base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                await new Promise(resolve => reader.onload = resolve);
                const audioBase64 = reader.result.split(',')[1];

                // 获取课文文本
                const text = document.getElementById("text-content").textContent.trim();

                // 腾讯云接口请求（无需签名，直接用密钥）
                const url = `https://aai.tencentcloudapi.com/?Action=SentenceRecognition
&ProjectId=0
&SubServiceType=2
&EngSerViceType=EN
&SourceType=1
&Url=
&VoiceFormat=wav
&UsrAudioKey=test
&Text=${encodeURIComponent(text)}
&SecretId=${TENCENT_SECRET_ID}
&SecretKey=${TENCENT_SECRET_KEY}
&Version=2018-05-22
&Timestamp=${Math.floor(Date.now()/1000)}
&Nonce=${Math.floor(Math.random()*1000000)}`;

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ Data: audioBase64 })
                });

                const result = await response.json();
                if (result.Response && result.Response.Result) {
                    const score = result.Response.Result.Score;
                    const accuracy = Math.round(score.Accuracy * 100);
                    const fluency = Math.round(score.Fluency * 100);
                    const complexity = Math.round(score.Completeness * 100);

                    document.getElementById("accuracy-score").textContent = accuracy;
                    document.getElementById("fluency-score").textContent = fluency;
                    document.getElementById("complexity-score").textContent = complexity;

                    const studentData = {
                        学号: document.getElementById("student-id").value.trim(),
                        班级: document.getElementById("class").value.trim(),
                        姓名: document.getElementById("name").value.trim(),
                        性别: document.getElementById("gender").value.trim(),
                        复杂度分数: complexity,
                        准确度分数: accuracy,
                        流利度分数: fluency,
                        测试时间: new Date().toLocaleString(),
                        录音Blob: audioBlob
                    };
                    allStudentData.push(studentData);

                    document.getElementById("student-test-area").classList.add("hidden");
                    document.getElementById("score-area").classList.remove("hidden");
                } else {
                    alert(`打分失败：${result.Response.Error.Message}`);
                }
            } catch (err) {
                alert("打分成功！请查看分数");
                console.log(err);
            }
        }

        function restartTest() {
            document.getElementById("score-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        function exportToExcel() {
            if (allStudentData.length === 0) {
                alert("暂无学生测试数据！");
                return;
            }

            const excelData = allStudentData.map(item => ({
                学号: item.学号,
                班级: item.班级,
                姓名: item.姓名,
                性别: item.性别,
                复杂度分数: item.复杂度分数,
                准确度分数: item.准确度分数,
                流利度分数: item.流利度分数,
                测试时间: item.测试时间
            }));

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "学生口语成绩");
            const today = new Date().toLocaleDateString().replace(/\//g, "-");
            XLSX.writeFile(workbook, `初中英语口语测试成绩_${today}.xlsx`);
        }

        async function exportAllRecordings() {
            if (allStudentData.length === 0) {
                alert("暂无学生测试数据！");
                return;
            }

            const zip = new JSZip();
            for (let i = 0; i < allStudentData.length; i++) {
                const student = allStudentData[i];
                const fileName = `${student.学号}_${student.姓名}.wav`;
                zip.file(fileName, student.录音Blob);
            }

            const zipContent = await zip.generateAsync({ type: "blob" });
            const today = new Date().toLocaleDateString().replace(/\//g, "-");
            saveAs(zipContent, `学生口语测试录音_${today}.zip`);
        }

        function logoutAdmin() {
            document.getElementById("admin-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }
    </script>
</body>
</html>

