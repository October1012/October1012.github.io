<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- æ·»åŠ  Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: å¾®è½¯é›…é»‘, Arial; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, select { width: 100%; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; }
        button { background: #4CAF50; color: white; padding: 15px 30px; font-size: 20px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 10px 0 0; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .hidden { display: none; }
        #text-content { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; line-height: 1.8; border-left: 5px solid #4CAF50; }
        .admin-area { text-align: center; padding: 30px 0; }
        .tip-text { color: #666; margin: 10px 0; font-size: 16px; }
        .recording { animation: pulse 1s infinite; background: #ff4444 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .score-display { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¿¡æ¯å¡«å†™åŒº -->
        <div id="info-form">
            <h1 style="text-align: center; color: #2c3e50;">åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•</h1>
            <div class="form-group">
                <label for="student-id">å­¦å·</label>
                <input type="text" id="student-id" placeholder="è¯·è¾“å…¥å­¦å·ï¼ˆå¦‚2025001ï¼‰" required>
            </div>
            <div class="form-group">
                <label for="class">ç­çº§</label>
                <input type="text" id="class" placeholder="è¯·è¾“å…¥ç­çº§ï¼ˆå¦‚åˆä¸€1ç­ï¼‰" required>
            </div>
            <div class="form-group">
                <label for="name">å§“å</label>
                <input type="text" id="name" placeholder="è¯·è¾“å…¥å§“å" required>
            </div>
            <div class="form-group">
                <label for="gender">æ€§åˆ«</label>
                <select id="gender" required>
                    <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
            </div>
            <button onclick="checkIdentity()" style="width: 100%; background: #3498db;">è¿›å…¥ç³»ç»Ÿ</button>
            <p class="tip-text">æç¤ºï¼šè¯·è¾“å…¥æ‚¨çš„ä¸ªäººä¿¡æ¯å¼€å§‹æµ‹è¯•</p>
        </div>

        <!-- å­¦ç”Ÿæµ‹è¯•åŒº -->
        <div id="student-test-area" class="hidden">
            <h2 style="color: #2c3e50;">è¯·æœ—è¯»ä¸‹é¢çš„è‹±è¯­è¯¾æ–‡</h2>
            <div id="text-content">
                <strong>My School Life</strong><br>
                My school is a beautiful place. I go to school from Monday to Friday. We have many subjects, like English, math and music. My favorite subject is English. Our English teacher is kind and helpful. After class, I often play games with my classmates. I love my school life very much.
            </div>
            <div style="text-align: center;">
                <button id="start-btn" onclick="startRecording()">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                <button id="stop-btn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>
            </div>
            <p id="recording-status" style="text-align: center; font-size: 18px; margin: 20px 0; padding: 10px; border-radius: 5px;"></p>
            <button id="submit-btn" onclick="submitRecording()" class="hidden" disabled style="width: 100%; background: #e74c3c;">æäº¤å½•éŸ³</button>
        </div>

        <!-- ç®¡ç†å‘˜åŒº -->
        <div id="admin-area" class="hidden admin-area">
            <h1 style="color: #2c3e50;">ç®¡ç†å‘˜æ¨¡å¼ - æ•°æ®å¯¼å‡º</h1>
            <div class="score-display">
                <p style="font-size: 20px; margin: 0;">å½“å‰å·²å­˜å‚¨ <span id="data-count" style="color: #e74c3c; font-weight: bold;">0</span> åå­¦ç”Ÿçš„æµ‹è¯•æ•°æ®</p>
            </div>
            <button onclick="refreshData()" style="background: #4CAF50;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button onclick="exportToExcel()" style="background: #2196F3;">ğŸ“Š å¯¼å‡ºæˆç»©ï¼ˆExcelï¼‰</button>
            <button onclick="exportAllRecordings()" style="background: #ff9800;">ğŸµ å¯¼å‡ºå½•éŸ³ï¼ˆZIPåŒ…ï¼‰</button>
            <button onclick="clearAllData()" style="background: #ff5722;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <button onclick="logoutAdmin()" style="background: #f44336; margin-top: 20px;">é€€å‡ºç®¡ç†å‘˜</button>
        </div>

        <!-- ç½‘ç»œçŠ¶æ€æ˜¾ç¤º -->
        <div id="network-status" style="text-align: center; margin-top: 20px; font-size: 14px; color: #666;"></div>
    </div>

    <script>
        // ================== é‡è¦é…ç½® ==================
        // è®¾ç½®ï¼štrue=ä½¿ç”¨äº‘å­˜å‚¨ï¼Œfalse=ä»…æœ¬åœ°å­˜å‚¨ï¼ˆå¦‚æœäº‘å­˜å‚¨æœ‰é—®é¢˜ï¼‰
        const USE_CLOUD_STORAGE = true;
        
        // Supabase äº‘æ•°æ®åº“é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å¯†é’¥ï¼‰
        const SUPABASE_URL = 'https://lokppsuoecimireoypah.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxva3Bwc3VvZWNpbWlyZW95cGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTM5NzUsImV4cCI6MjA4MDA2OTk3NX0.UHL4-QI1pjEcA5bKn0nzNvuseI73oIHa3ubDe5E4d7E'; // ä»¥eyJå¼€å¤´çš„é•¿å­—ç¬¦ä¸²
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆä»…åœ¨ä½¿ç”¨äº‘å­˜å‚¨æ—¶ï¼‰
        let supabase = null;
        if (USE_CLOUD_STORAGE) {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', error);
                alert('äº‘å­˜å‚¨åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨');
            }
        }

        // ç®¡ç†å‘˜èº«ä»½
        const ADMIN_CONFIG = {
            å­¦å·: "admin001",
            ç­çº§: "ç®¡ç†å‘˜",
            å§“å: "ç®¡ç†å‘˜",
            æ€§åˆ«: "ç”·"
        };

        // å…¨å±€å˜é‡
        let allStudentData = [];
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;

        // ================== æ•°æ®åº“å‡½æ•° ==================
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            if (!USE_CLOUD_STORAGE || !supabase) {
                console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
                return false;
            }
            
            try {
                console.log('æµ‹è¯•æ•°æ®åº“è¿æ¥...');
                const { data, error } = await supabase
                    .from('student_records')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.error('æ•°æ®åº“è¿æ¥é”™è¯¯:', error);
                    return false;
                }
                
                console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');
                return true;
            } catch (error) {
                console.error('æ•°æ®åº“è¿æ¥å¤±è´¥:', error);
                return false;
            }
        }

        // ä¿å­˜æ•°æ®åˆ°äº‘ç«¯
        async function saveToCloud(studentData) {
            if (!USE_CLOUD_STORAGE || !supabase) {
                console.log('äº‘å­˜å‚¨æœªå¯ç”¨ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°');
                return false;
            }
            
            try {
                console.log('å¼€å§‹ä¿å­˜æ•°æ®åˆ°äº‘ç«¯...');
                
                // æµ‹è¯•è¿æ¥
                const connected = await testDatabaseConnection();
                if (!connected) {
                    throw new Error('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“');
                }
                
                // è½¬æ¢å½•éŸ³ä¸ºBase64
                const audioBase64 = await blobToBase64(studentData.å½•éŸ³Blob);
                console.log('éŸ³é¢‘æ•°æ®å¤§å°:', audioBase64.length, 'å­—èŠ‚');
                
                const { data, error } = await supabase
                    .from('student_records')
                    .insert([
                        {
                            å­¦å·: studentData.å­¦å·,
                            ç­çº§: studentData.ç­çº§,
                            å§“å: studentData.å§“å,
                            æ€§åˆ«: studentData.æ€§åˆ«,
                            å‡†ç¡®åº¦åˆ†æ•°: studentData.å‡†ç¡®åº¦åˆ†æ•°,
                            æµåˆ©åº¦åˆ†æ•°: studentData.æµåˆ©åº¦åˆ†æ•°,
                            å®Œæ•´åº¦åˆ†æ•°: studentData.å®Œæ•´åº¦åˆ†æ•°,
                            æµ‹è¯•æ—¶é—´: studentData.æµ‹è¯•æ—¶é—´,
                            å½•éŸ³æ•°æ®: audioBase64
                        }
                    ]);
                
                if (error) {
                    console.error('Supabaseæ’å…¥é”™è¯¯:', error);
                    throw error;
                }
                
                console.log('âœ… äº‘ç«¯ä¿å­˜æˆåŠŸï¼ŒID:', data[0]?.id);
                updateNetworkStatus('âœ… æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯');
                return true;
                
            } catch (error) {
                console.error('äº‘å­˜å‚¨å¤±è´¥:', error);
                updateNetworkStatus('âŒ äº‘å­˜å‚¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                return false;
            }
        }

        // ä»äº‘ç«¯åŠ è½½æ•°æ®
        async function loadFromCloud() {
            if (!USE_CLOUD_STORAGE || !supabase) {
                console.log('äº‘å­˜å‚¨æœªå¯ç”¨ï¼Œä»æœ¬åœ°åŠ è½½');
                loadFromLocal();
                return false;
            }
            
            try {
                console.log('ä»äº‘ç«¯åŠ è½½æ•°æ®...');
                
                const connected = await testDatabaseConnection();
                if (!connected) {
                    throw new Error('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“');
                }
                
                const { data, error } = await supabase
                    .from('student_records')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('ä»äº‘ç«¯åŠ è½½åˆ°', data.length, 'æ¡è®°å½•');
                
                // è½¬æ¢æ•°æ®æ ¼å¼
                allStudentData = [];
                data.forEach(item => {
                    try {
                        const audioBlob = base64ToBlob(item.å½•éŸ³æ•°æ®, 'audio/wav');
                        allStudentData.push({
                            å­¦å·: item.å­¦å·,
                            ç­çº§: item.ç­çº§,
                            å§“å: item.å§“å,
                            æ€§åˆ«: item.æ€§åˆ«,
                            å‡†ç¡®åº¦åˆ†æ•°: item.å‡†ç¡®åº¦åˆ†æ•°,
                            æµåˆ©åº¦åˆ†æ•°: item.æµåˆ©åº¦åˆ†æ•°,
                            å®Œæ•´åº¦åˆ†æ•°: item.å®Œæ•´åº¦åˆ†æ•°,
                            æµ‹è¯•æ—¶é—´: item.æµ‹è¯•æ—¶é—´,
                            å½•éŸ³Blob: audioBlob
                        });
                    } catch (e) {
                        console.warn('è½¬æ¢å½•éŸ³æ•°æ®å¤±è´¥ï¼Œä¿å­˜åŸºæœ¬ä¿¡æ¯:', e);
                        allStudentData.push({
                            å­¦å·: item.å­¦å·,
                            ç­çº§: item.ç­çº§,
                            å§“å: item.å§“å,
                            æ€§åˆ«: item.æ€§åˆ«,
                            å‡†ç¡®åº¦åˆ†æ•°: item.å‡†ç¡®åº¦åˆ†æ•°,
                            æµåˆ©åº¦åˆ†æ•°: item.æµåˆ©åº¦åˆ†æ•°,
                            å®Œæ•´åº¦åˆ†æ•°: item.å®Œæ•´åº¦åˆ†æ•°,
                            æµ‹è¯•æ—¶é—´: item.æµ‹è¯•æ—¶é—´,
                            å½•éŸ³Blob: null
                        });
                    }
                });
                
                // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
                localStorage.setItem('allStudentData', JSON.stringify(allStudentData.map(item => {
                    const { å½•éŸ³Blob, ...dataWithoutBlob } = item;
                    return dataWithoutBlob;
                })));
                
                updateNetworkStatus('âœ… å·²ä»äº‘ç«¯åŠ è½½ ' + allStudentData.length + ' æ¡æ•°æ®');
                return true;
                
            } catch (error) {
                console.error('äº‘åŠ è½½å¤±è´¥:', error);
                updateNetworkStatus('âŒ äº‘åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                loadFromLocal();
                return false;
            }
        }

        // ä»æœ¬åœ°åŠ è½½æ•°æ®
        function loadFromLocal() {
            try {
                const localData = localStorage.getItem('allStudentData');
                if (localData) {
                    const parsedData = JSON.parse(localData);
                    allStudentData = parsedData.map(item => ({
                        ...item,
                        å½•éŸ³Blob: null // æœ¬åœ°å­˜å‚¨ä¸åŒ…å«å½•éŸ³æ–‡ä»¶
                    }));
                    console.log('ä»æœ¬åœ°åŠ è½½åˆ°', allStudentData.length, 'æ¡è®°å½•');
                } else {
                    allStudentData = [];
                    console.log('æœ¬åœ°æ— æ•°æ®');
                }
            } catch (e) {
                console.error('æœ¬åœ°åŠ è½½å¤±è´¥:', e);
                allStudentData = [];
            }
        }

        // æ¸…ç©ºäº‘æ•°æ®
        async function clearCloudData() {
            if (!USE_CLOUD_STORAGE || !supabase) {
                console.log('äº‘å­˜å‚¨æœªå¯ç”¨ï¼Œä»…æ¸…ç©ºæœ¬åœ°æ•°æ®');
                return true;
            }
            
            try {
                const { error } = await supabase
                    .from('student_records')
                    .delete()
                    .neq('id', 0); // åˆ é™¤æ‰€æœ‰è®°å½•
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('æ¸…ç©ºäº‘æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }

        // ================== å·¥å…·å‡½æ•° ==================
        
        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const result = reader.result;
                    const base64 = result.split(',')[1];
                    resolve(base64);
                };
                reader.readAsDataURL(blob);
            });
        }

        function base64ToBlob(base64, mimeType) {
            try {
                const byteCharacters = atob(base64);
                const byteArrays = [];
                for (let offset = 0; offset < byteCharacters.length; offset += 1024) {
                    const slice = byteCharacters.slice(offset, offset + 1024);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                return new Blob(byteArrays, { type: mimeType });
            } catch (error) {
                console.error('Base64è½¬Blobå¤±è´¥:', error);
                return new Blob([], { type: mimeType });
            }
        }

        function updateNetworkStatus(message) {
            const statusDiv = document.getElementById('network-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.style.color = message.includes('âœ…') ? 'green' : 'red';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 5000);
            }
        }

        function updateDataCount() {
            const count = allStudentData.length;
            const countElement = document.getElementById("data-count");
            if (countElement) {
                countElement.textContent = count;
            }
        }

        async function refreshData() {
            try {
                setLoading(true, 'åˆ·æ–°æ•°æ®ä¸­...');
                await loadFromCloud();
                updateDataCount();
                setLoading(false);
                alert(`æ•°æ®å·²åˆ·æ–°ï¼Œå½“å‰å…±æœ‰ ${allStudentData.length} æ¡è®°å½•`);
            } catch (error) {
                setLoading(false);
                alert('åˆ·æ–°æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        function setLoading(isLoading, message = '') {
            if (isLoading) {
                document.body.classList.add('loading');
                if (message) {
                    updateNetworkStatus(message);
                }
            } else {
                document.body.classList.remove('loading');
            }
        }

        // ================== ä¸»è¦åŠŸèƒ½å‡½æ•° ==================
        
        // 1. èº«ä»½éªŒè¯
        function checkIdentity() {
            const inputId = document.getElementById("student-id").value.trim();
            const inputClass = document.getElementById("class").value.trim();
            const inputName = document.getElementById("name").value.trim();
            const inputGender = document.getElementById("gender").value.trim();

            if (!inputId || !inputClass || !inputName || !inputGender) {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼"); 
                return;
            }

            // ç®¡ç†å‘˜éªŒè¯
            if (inputId === ADMIN_CONFIG.å­¦å· && inputClass === ADMIN_CONFIG.ç­çº§ && 
                inputName === ADMIN_CONFIG.å§“å && inputGender === ADMIN_CONFIG.æ€§åˆ«) {
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("admin-area").classList.remove("hidden");
                updateDataCount();
            } else {
                // å­¦ç”ŸéªŒè¯
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("student-test-area").classList.remove("hidden");
                resetRecordingState();
            }
        }

        function resetRecordingState() {
            document.getElementById("recording-status").textContent = "";
            document.getElementById("start-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
            document.getElementById("submit-btn").classList.add("hidden");
            document.getElementById("submit-btn").disabled = true;
            document.getElementById("start-btn").classList.remove("recording");
            audioChunks = []; 
            audioBlob = null;
        }

        // 2. å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstart = () => {
                    document.getElementById("recording-status").textContent = "ğŸ¤ æ­£åœ¨å½•éŸ³...è¯·æ¸…æ™°æœ—è¯»è¯¾æ–‡";
                    document.getElementById("recording-status").style.background = "#ffeaa7";
                    document.getElementById("start-btn").classList.add("recording");
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    document.getElementById("recording-status").textContent = "âœ… å½•éŸ³å®Œæˆï¼ç‚¹å‡»æäº¤";
                    document.getElementById("recording-status").style.background = "#55efc4";
                    document.getElementById("start-btn").classList.remove("recording");
                    console.log('å½•éŸ³å®Œæˆï¼Œæ–‡ä»¶å¤§å°:', audioBlob.size, 'å­—èŠ‚');
                };
                
                mediaRecorder.start(1000); // æ¯1ç§’æ”¶é›†ä¸€æ¬¡æ•°æ®
                document.getElementById("start-btn").disabled = true;
                document.getElementById("stop-btn").disabled = false;
                
            } catch (err) {
                console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', err);
                alert("è¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£ï¼");
            }
        }

        // 3. åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                if (mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
            }
            document.getElementById("submit-btn").classList.remove("hidden");
            document.getElementById("submit-btn").disabled = false;
            document.getElementById("start-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        // 4. æäº¤å½•éŸ³
        async function submitRecording() {
            if (!audioBlob) { 
                alert("è¯·å…ˆå½•éŸ³å†æäº¤ï¼"); 
                return; 
            }
            
            try {
                setLoading(true, 'å¤„ç†ä¸­...');
                document.getElementById("submit-btn").disabled = true;
                document.getElementById("submit-btn").textContent = "è¯„æµ‹ä¸­...";
                
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†æ•°
                const duration = Math.max(1, audioBlob.size / 5000); // æ¨¡æ‹Ÿæ—¶é•¿
                const baseScore = Math.min(85, 60 + duration);
                const randomVariation = (Math.random() - 0.5) * 15;
                const finalScore = Math.max(50, Math.min(100, baseScore + randomVariation));
                
                const studentData = {
                    å­¦å·: document.getElementById("student-id").value.trim(),
                    ç­çº§: document.getElementById("class").value.trim(),
                    å§“å: document.getElementById("name").value.trim(),
                    æ€§åˆ«: document.getElementById("gender").value.trim(),
                    å‡†ç¡®åº¦åˆ†æ•°: Math.round(finalScore * 0.9),
                    æµåˆ©åº¦åˆ†æ•°: Math.round(finalScore * 0.85),
                    å®Œæ•´åº¦åˆ†æ•°: Math.round(finalScore * 0.95),
                    æµ‹è¯•æ—¶é—´: new Date().toLocaleString(),
                    å½•éŸ³Blob: audioBlob
                };
                
                console.log('å­¦ç”Ÿæ•°æ®å‡†å¤‡å®Œæˆ:', studentData.å­¦å·, studentData.å§“å);
                
                // ä¿å­˜æ•°æ®ï¼ˆäº‘ç«¯+æœ¬åœ°åŒå¤‡ä»½ï¼‰
                let cloudSuccess = false;
                if (USE_CLOUD_STORAGE && supabase) {
                    cloudSuccess = await saveToCloud(studentData);
                }
                
                // æ— è®ºäº‘ç«¯æ˜¯å¦æˆåŠŸï¼Œéƒ½ä¿å­˜åˆ°æœ¬åœ°
                allStudentData.push(studentData);
                
                // ä¿å­˜åŸºæœ¬ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¸å«å½•éŸ³æ–‡ä»¶ï¼‰
                const localData = allStudentData.map(item => {
                    const { å½•éŸ³Blob, ...dataWithoutBlob } = item;
                    return dataWithoutBlob;
                });
                localStorage.setItem('allStudentData', JSON.stringify(localData));
                
                updateDataCount();
                
                if (cloudSuccess) {
                    alert("âœ… æµ‹è¯•å·²å®Œæˆï¼æ•°æ®å·²ä¿å­˜åˆ°äº‘ç«¯ã€‚\næˆç»©å°†ç”±è€å¸ˆç»Ÿä¸€å…¬å¸ƒã€‚");
                } else {
                    alert("âœ… æµ‹è¯•å·²å®Œæˆï¼æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ã€‚\næˆç»©å°†ç”±è€å¸ˆç»Ÿä¸€å…¬å¸ƒã€‚");
                }
                
                restartTest();
                
            } catch (err) {
                console.error('æäº¤å¤±è´¥:', err);
                alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•: " + err.message);
            } finally {
                setLoading(false);
                document.getElementById("submit-btn").disabled = false;
                document.getElementById("submit-btn").textContent = "æäº¤å½•éŸ³";
            }
        }

        function restartTest() {
            document.getElementById("student-test-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // 5. å¯¼å‡ºExcel
        function exportToExcel() {
            if (allStudentData.length === 0) { 
                alert("æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼"); 
                return; 
            }
            
            const excelData = allStudentData.map(item => {
                const { å½•éŸ³Blob, ...data } = item;
                return data;
            });
            
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "å­¦ç”Ÿæˆç»©");
            
            const today = new Date().toLocaleDateString().replace(/\//g, "-");
            XLSX.writeFile(workbook, `åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•æˆç»©_${today}.xlsx`);
        }

        // 6. å¯¼å‡ºå½•éŸ³ - æ ‡å‡†å‘½åï¼ˆå­¦å·_å§“å.wavï¼‰
        async function exportAllRecordings() {
            if (allStudentData.length === 0) { 
                alert("æš‚æ— å­¦ç”Ÿæµ‹è¯•æ•°æ®ï¼Œæ— æ³•å¯¼å‡ºï¼"); 
                return; 
            }

            try {
                setLoading(true, 'å‡†å¤‡å½•éŸ³æ–‡ä»¶...');
                
                const zip = new JSZip();
                let validRecordings = 0;
        
                // é€ä¸ªæ·»åŠ å½•éŸ³æ–‡ä»¶ï¼ˆæ ‡å‡†å‘½åï¼šå­¦å·_å§“å.wavï¼‰
                allStudentData.forEach((student, index) => {
                    if (student.å½•éŸ³Blob && student.å½•éŸ³Blob.size > 100) { // ç¡®ä¿ä¸æ˜¯ç©ºæ–‡ä»¶
                        // æ ‡å‡†æ–‡ä»¶åæ ¼å¼ï¼šå­¦å·_å§“å.wav
                        const fileName = `${student.å­¦å·}_${student.å§“å}.wav`;
                        zip.file(fileName, student.å½•éŸ³Blob);
                        validRecordings++;
                        console.log(`âœ… æ·»åŠ å½•éŸ³: ${fileName}`);
                    } else {
                        console.log(`âŒ è·³è¿‡: ${student.å­¦å·}_${student.å§“å} (æ— å½•éŸ³æ•°æ®)`);
                    }
                });

                if (validRecordings === 0) {
                    setLoading(false);
                    alert("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å½•éŸ³æ–‡ä»¶ï¼\nè¯·ç¡®ä¿å­¦ç”Ÿå·²å®Œæˆå½•éŸ³æµ‹è¯•ã€‚");
                    return;
                }

                // ç”Ÿæˆå¹¶ä¸‹è½½ZIPåŒ…
                const zipContent = await zip.generateAsync({ type: "blob" });
                const today = new Date().toLocaleDateString().replace(/\//g, "-");
                saveAs(zipContent, `åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•å½•éŸ³_${today}.zip`);
                
                setLoading(false);
                alert(`ğŸ‰ å¯¼å‡ºæˆåŠŸï¼\nå…±å¯¼å‡º ${validRecordings} ä¸ªå½•éŸ³æ–‡ä»¶\næ–‡ä»¶åï¼šå­¦å·_å§“å.wav`);
        
            } catch (err) {
                setLoading(false);
                console.error('å¯¼å‡ºå½•éŸ³å¤±è´¥:', err);
                alert('å¯¼å‡ºå½•éŸ³æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•ï¼š' + err.message);
            }
        }

        // 7. æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAllData() {
            if (!confirm("âš ï¸  ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å­¦ç”Ÿçš„æµ‹è¯•è®°å½•ï¼")) {
                return;
            }
            
            try {
                setLoading(true, 'æ¸…ç©ºæ•°æ®ä¸­...');
                
                let cloudSuccess = false;
                if (USE_CLOUD_STORAGE && supabase) {
                    cloudSuccess = await clearCloudData();
                }
                
                // æ¸…ç©ºæœ¬åœ°æ•°æ®
                allStudentData = [];
                localStorage.removeItem('allStudentData');
                updateDataCount();
                
                setLoading(false);
                
                if (cloudSuccess) {
                    alert("âœ… äº‘ç«¯å’Œæœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼");
                } else if (USE_CLOUD_STORAGE) {
                    alert("âœ… æœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼\nâš ï¸  äº‘ç«¯æ¸…ç©ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
                } else {
                    alert("âœ… æœ¬åœ°æ•°æ®å·²æ¸…ç©ºï¼");
                }
                
            } catch (error) {
                setLoading(false);
                alert('æ¸…ç©ºæ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // 8. é€€å‡ºç®¡ç†å‘˜
        function logoutAdmin() {
            document.getElementById("admin-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // ================== åˆå§‹åŒ– ==================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ä¸­...');
            
            // æ˜¾ç¤ºå½“å‰å­˜å‚¨æ¨¡å¼
            if (USE_CLOUD_STORAGE) {
                console.log('ä½¿ç”¨äº‘å­˜å‚¨æ¨¡å¼');
                updateNetworkStatus('ğŸŒ äº‘å­˜å‚¨æ¨¡å¼å·²å¯ç”¨');
            } else {
                console.log('ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼');
                updateNetworkStatus('ğŸ’» æœ¬åœ°å­˜å‚¨æ¨¡å¼');
            }
            
            // åŠ è½½æ•°æ®
            await loadFromCloud();
            updateDataCount();
            
            // æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼ˆä»…äº‘å­˜å‚¨æ¨¡å¼ï¼‰
            if (USE_CLOUD_STORAGE && supabase) {
                setTimeout(async () => {
                    const connected = await testDatabaseConnection();
                    if (connected) {
                        updateNetworkStatus('âœ… äº‘ç«¯è¿æ¥æ­£å¸¸');
                    } else {
                        updateNetworkStatus('âš ï¸  äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                    }
                }, 1000);
            }
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æ•°æ®:', allStudentData.length, 'æ¡');
        });
    </script>
</body>
</html>
