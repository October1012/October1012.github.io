<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body { font-family: å¾®è½¯é›…é»‘, Arial; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, select { width: 100%; padding: 12px; font-size: 18px; border: 2px solid #ddd; border-radius: 8px; }
        button { background: #4CAF50; color: white; padding: 15px 30px; font-size: 20px; border: none; border-radius: 8px; cursor: pointer; margin: 10px 10px 0 0; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .hidden { display: none; }
        #text-content { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; line-height: 1.8; border-left: 5px solid #4CAF50; }
        .admin-area { text-align: center; padding: 30px 0; }
        .tip-text { color: #666; margin: 10px 0; font-size: 16px; }
        .recording { animation: pulse 1s infinite; background: #ff4444 !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .score-display { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¿¡æ¯å¡«å†™åŒº -->
        <div id="info-form">
            <h1 style="text-align: center; color: #2c3e50;">åˆä¸­è‹±è¯­å£è¯­æµ‹è¯•</h1>
            <div class="form-group">
                <label for="student-id">å­¦å·</label>
                <input type="text" id="student-id" placeholder="è¯·è¾“å…¥å­¦å·ï¼ˆå¦‚2025001ï¼‰" required>
            </div>
            <div class="form-group">
                <label for="class">ç­çº§</label>
                <input type="text" id="class" placeholder="è¯·è¾“å…¥ç­çº§ï¼ˆå¦‚åˆä¸€1ç­ï¼‰" required>
            </div>
            <div class="form-group">
                <label for="name">å§“å</label>
                <input type="text" id="name" placeholder="è¯·è¾“å…¥å§“å" required>
            </div>
            <div class="form-group">
                <label for="gender">æ€§åˆ«</label>
                <select id="gender" required>
                    <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
            </div>
            <button onclick="checkIdentity()" style="width: 100%; background: #3498db;">è¿›å…¥ç³»ç»Ÿ</button>
            <p class="tip-text">æç¤ºï¼šå­¦ç”Ÿè¾“å…¥ä¸ªäººä¿¡æ¯</p>
        </div>

        <!-- å­¦ç”Ÿæµ‹è¯•åŒº -->
        <div id="student-test-area" class="hidden">
            <h2 style="color: #2c3e50;">è¯·æœ—è¯»ä¸‹é¢çš„è‹±è¯­è¯¾æ–‡</h2>
            <div id="text-content">
                <strong>My School Life</strong><br>
                My school is a beautiful place. I go to school from Monday to Friday. We have many subjects, like English, math and music. My favorite subject is English. Our English teacher is kind and helpful. After class, I often play games with my classmates. I love my school life very much.
            </div>
            <div style="text-align: center;">
                <button id="start-btn" onclick="startRecording()">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                <button id="stop-btn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>
            </div>
            <p id="recording-status" style="text-align: center; font-size: 18px; margin: 20px 0; padding: 10px; border-radius: 5px;"></p>
            <button id="submit-btn" onclick="submitRecording()" class="hidden" disabled style="width: 100%; background: #e74c3c;">æäº¤å½•éŸ³</button>
        </div>

        <!-- ç®¡ç†å‘˜åŒº -->
        <div id="admin-area" class="hidden admin-area">
            <h1 style="color: #2c3e50;">ç®¡ç†å‘˜æ¨¡å¼ - æ•°æ®å¯¼å‡º</h1>
            <div class="score-display">
                <p style="font-size: 20px; margin: 0;">å½“å‰å·²å­˜å‚¨ <span id="data-count" style="color: #e74c3c; font-weight: bold;">0</span> åå­¦ç”Ÿçš„æµ‹è¯•æ•°æ®</p>
            </div>
            <button onclick="exportToExcel()" style="background: #2196F3;">ğŸ“Š å¯¼å‡ºæˆç»©ï¼ˆExcelï¼‰</button>
            <button onclick="exportAllRecordings()" style="background: #ff9800;">ğŸµ å¯¼å‡ºå½•éŸ³ï¼ˆZIPåŒ…ï¼‰</button>
            <button onclick="clearAllData()" style="background: #ff5722;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <button onclick="logoutAdmin()" style="background: #f44336; margin-top: 20px;">é€€å‡ºç®¡ç†å‘˜</button>
        </div>
    </div>

    <script>
        // ç®¡ç†å‘˜èº«ä»½
        const ADMIN_CONFIG = {
            å­¦å·: "admin001",
            ç­çº§: "ç®¡ç†å‘˜",
            å§“å: "ç®¡ç†å‘˜",
            æ€§åˆ«: "ç”·"
        };

        // å…¨å±€å˜é‡
        let allStudentData = JSON.parse(localStorage.getItem('allStudentData') || '[]');
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;

        // 1. èº«ä»½éªŒè¯
        function checkIdentity() {
            const inputId = document.getElementById("student-id").value.trim();
            const inputClass = document.getElementById("class").value.trim();
            const inputName = document.getElementById("name").value.trim();
            const inputGender = document.getElementById("gender").value.trim();

            if (!inputId || !inputClass || !inputName || !inputGender) {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼"); return;
            }

            // ç®¡ç†å‘˜éªŒè¯
            if (inputId === ADMIN_CONFIG.å­¦å· && inputClass === ADMIN_CONFIG.ç­çº§ && 
                inputName === ADMIN_CONFIG.å§“å && inputGender === ADMIN_CONFIG.æ€§åˆ«) {
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("admin-area").classList.remove("hidden");
                document.getElementById("data-count").textContent = allStudentData.length;
            } else {
                // å­¦ç”ŸéªŒè¯
                document.getElementById("info-form").classList.add("hidden");
                document.getElementById("student-test-area").classList.remove("hidden");
                resetRecordingState();
            }
        }

        function resetRecordingState() {
            document.getElementById("recording-status").textContent = "";
            document.getElementById("start-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
            document.getElementById("submit-btn").classList.add("hidden");
            document.getElementById("submit-btn").disabled = true;
            document.getElementById("start-btn").classList.remove("recording");
            audioChunks = []; audioBlob = null;
        }

        // 2. å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => e.data.size > 0 && audioChunks.push(e.data);
                mediaRecorder.onstart = () => {
                    document.getElementById("recording-status").textContent = "ğŸ¤ æ­£åœ¨å½•éŸ³...è¯·æ¸…æ™°æœ—è¯»è¯¾æ–‡";
                    document.getElementById("recording-status").style.background = "#ffeaa7";
                    document.getElementById("start-btn").classList.add("recording");
                };
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    document.getElementById("recording-status").textContent = "âœ… å½•éŸ³å®Œæˆï¼ç‚¹å‡»æäº¤";
                    document.getElementById("recording-status").style.background = "#55efc4";
                };
                mediaRecorder.start();
                document.getElementById("start-btn").disabled = true;
                document.getElementById("stop-btn").disabled = false;
            } catch (err) {
                alert("è¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£ï¼");
            }
        }

        // 3. åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            document.getElementById("submit-btn").classList.remove("hidden");
            document.getElementById("submit-btn").disabled = false;
            document.getElementById("start-btn").disabled = false;
            document.getElementById("stop-btn").disabled = true;
        }

        // 4. æäº¤å½•éŸ³ï¼ˆæ¨¡æ‹Ÿè¯„åˆ†ï¼‰
        async function submitRecording() {
            if (!audioBlob) { alert("è¯·å…ˆå½•éŸ³ï¼"); return; }
            
            try {
                document.getElementById("submit-btn").disabled = true;
                document.getElementById("submit-btn").textContent = "è¯„æµ‹ä¸­...";
                
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ç”Ÿæˆæ¨¡æ‹Ÿåˆ†æ•°ï¼ˆåŸºäºå½•éŸ³æ—¶é•¿å’Œéšæœºæ•°ï¼‰
                const duration = audioBlob.size / 1000; // ç®€å•æ¨¡æ‹Ÿæ—¶é•¿
                const baseScore = Math.min(85, 60 + duration / 10);
                const randomVariation = (Math.random() - 0.5) * 20;
                const finalScore = Math.max(50, Math.min(100, baseScore + randomVariation));
                
                const studentData = {
                    å­¦å·: document.getElementById("student-id").value.trim(),
                    ç­çº§: document.getElementById("class").value.trim(),
                    å§“å: document.getElementById("name").value.trim(),
                    æ€§åˆ«: document.getElementById("gender").value.trim(),
                    å‡†ç¡®åº¦åˆ†æ•°: Math.round(finalScore * 0.9),
                    æµåˆ©åº¦åˆ†æ•°: Math.round(finalScore * 0.85),
                    å®Œæ•´åº¦åˆ†æ•°: Math.round(finalScore * 0.95),
                    æµ‹è¯•æ—¶é—´: new Date().toLocaleString(),
                    å½•éŸ³Blob: audioBlob
                };
                
                allStudentData.push(studentData);
                localStorage.setItem('allStudentData', JSON.stringify(allStudentData));

                alert("æµ‹è¯•å·²å®Œæˆï¼æˆç»©å°†ç”±è€å¸ˆç»Ÿä¸€å…¬å¸ƒã€‚");
                restartTest();
            } catch (err) {
                alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•");
            } finally {
                document.getElementById("submit-btn").disabled = false;
                document.getElementById("submit-btn").textContent = "æäº¤å½•éŸ³";
            }
        }

        function restartTest() {
            document.getElementById("student-test-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // 5. å¯¼å‡ºExcel
        function exportToExcel() {
            if (allStudentData.length === 0) { alert("æš‚æ— æ•°æ®ï¼"); return; }
            const excelData = allStudentData.map(item => {
                const { å½•éŸ³Blob, ...data } = item; return data;
            });
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "å­¦ç”Ÿæˆç»©");
            XLSX.writeFile(workbook, `å£è¯­æµ‹è¯•æˆç»©_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 6. å¯¼å‡ºå½•éŸ³
        async function exportAllRecordings() {
            if (allStudentData.length === 0) { alert("æš‚æ— æ•°æ®ï¼"); return; }
            try {
                const zip = new JSZip();
                allStudentData.forEach(student => {
                    if (student.å½•éŸ³Blob) {
                        zip.file(`${student.å­¦å·}_${student.å§“å}.wav`, student.å½•éŸ³Blob);
                    }
                });
                const zipContent = await zip.generateAsync({ type: "blob" });
                saveAs(zipContent, `å­¦ç”Ÿå½•éŸ³_${new Date().toLocaleDateString()}.zip`);
                alert(`æˆåŠŸå¯¼å‡º ${allStudentData.length} ä¸ªå½•éŸ³æ–‡ä»¶ï¼`);
            } catch (err) {
                alert('å¯¼å‡ºå¤±è´¥');
            }
        }

        function clearAllData() {
            if (confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ")) {
                allStudentData = [];
                localStorage.removeItem('allStudentData');
                document.getElementById("data-count").textContent = 0;
                alert("æ•°æ®å·²æ¸…ç©ºï¼");
            }
        }

        function logoutAdmin() {
            document.getElementById("admin-area").classList.add("hidden");
            document.getElementById("info-form").classList.remove("hidden");
            document.getElementById("student-id").value = "";
            document.getElementById("class").value = "";
            document.getElementById("name").value = "";
            document.getElementById("gender").value = "";
        }

        // åˆå§‹åŒ–
        document.getElementById("data-count").textContent = allStudentData.length;
    </script>
</body>
</html>


